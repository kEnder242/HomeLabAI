    async def handle_start(self, request):
        global lab_process, current_lab_mode, last_logged_lab_pid, last_logged_lab_ready_state, last_logged_lab_status_message
        
        data = await request.json()
        mode = data.get("mode", "SERVICE_UNATTENDED")
        preferred_engine = data.get("engine", "OLLAMA")

        # 1. Transition Logic: If something is running, we MUST invalidate it to start fresh
        if lab_process and lab_process.poll() is None:
            logger.info(f"[TRANSITION] Invalidation triggered by new start request. Killing PID {lab_process.pid}...")
            await self.invalidate_resident_models()

        # 2. VRAM Guard: Select best engine after invalidation
        engine, avail = await self.select_optimal_engine(preferred_engine)
        logger.info(f"[VRAM GUARD] Available: {avail}MiB | Selected: {engine} (Preferred: {preferred_engine})")

        # 3. Setup Environment
        process_env = os.environ.copy()
        process_env.update(data.get("env", {}))
        process_env["PYTHONPATH"] = f"{process_env.get('PYTHONPATH', '')}:{LAB_DIR}/src"
        process_env["PYTHONUNBUFFERED"] = "1"
        process_env["USE_BRAIN_VLLM"] = "1" if engine == "vLLM" else "0"
        process_env["USE_BRAIN_STUB"] = "1" if engine == "STUB" else "0"

        if data.get("disable_ear", True): process_env["DISABLE_EAR"] = "1"
        else: process_env.pop("DISABLE_EAR", None)
        
        logger.info(f"Starting Lab server: Mode={mode}, Engine={engine}")

        with open(SERVER_LOG, 'w') as f: f.write('')

        try:
            lab_process = subprocess.Popen(
                [LAB_VENV_PYTHON, LAB_SERVER_PATH, "--mode", mode],
                cwd=LAB_DIR, env=process_env,
                stdout=subprocess.DEVNULL,
                stderr=open(SERVER_LOG, 'a', buffering=1)
            )
            current_lab_mode = mode
            last_logged_lab_pid = lab_process.pid
            return web.json_response({"status": "success", "message": "Lab server started.", "pid": lab_process.pid})
        except Exception as e:
            logger.error(f"Failed to start Lab server: {e}")
            return web.json_response({"status": "error", "message": str(e)}, status=500)
